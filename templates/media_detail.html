<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Media Details - SnapStream</title>
  <meta name="description" content="View media details and AI analysis results." />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-container">
      <a href="/" class="navbar-brand">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="23 7 16 12 23 17 23 7"></polygon>
          <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
        </svg>
        SnapStream
      </a>

      <div class="navbar-actions">
        <!-- User dropdown -->
        <div class="user-dropdown hidden">
          <button class="user-dropdown-toggle">
            <div class="user-avatar">U</div>
            <span class="username-display">User</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="user-dropdown-menu">
            <a href="/profile" class="dropdown-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              Profile Settings
            </a>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item" onclick="logout()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              Logout
            </button>
          </div>
        </div>

        <button class="navbar-toggle sidebar-toggle">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>
  </nav>

  <!-- Sidebar -->
  <aside class="sidebar">
    <nav class="sidebar-nav">
      <a href="/dashboard" class="sidebar-link">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        Dashboard
      </a>

      <a href="/upload" class="sidebar-link">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        Upload Media
      </a>

      <a href="/media" class="sidebar-link active">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        </svg>
        My Media
      </a>

      <a href="/notifications" class="sidebar-link">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        Notifications
      </a>

      <div class="sidebar-section">Account</div>

      <a href="/profile" class="sidebar-link">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        Profile Settings
      </a>

      <a href="#" class="sidebar-link" onclick="logout(); return false;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Logout
      </a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-with-sidebar" id="media-detail">
    <div class="container">

      <!-- Breadcrumb -->
      <div style="margin-bottom: 1.5rem;">
        <a href="/media" style="display:inline-flex; align-items:center; gap:0.5rem; color:var(--gray); font-size:0.875rem;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
          Back to Media Library
        </a>
      </div>

      <!-- Header -->
      <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:2rem; flex-wrap:wrap; gap:1rem;">
        <div>
          <h1 id="media-filename">Loading...</h1>
          <p>View media details and AI analysis results</p>
        </div>

        <div style="display:flex; gap:0.5rem;">
          <button class="btn btn-secondary" id="download-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Download
          </button>

          <button class="btn btn-danger" id="delete-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Delete
          </button>
        </div>
      </div>

      <!-- Content Grid -->
      <div class="media-detail">

        <!-- Viewer + Analysis -->
        <div>
          <div class="card">
            <div class="media-viewer" id="media-viewer" style="min-height:320px;">
              <div style="padding:30px; color:gray;">Loading preview...</div>
            </div>
          </div>

          <!-- Analysis -->
          <div class="card" style="margin-top:1.5rem;">
            <div class="card-header">
              <h3 style="margin:0;">AI Analysis Results</h3>
            </div>

            <div class="card-body">
              <!-- Tabs -->
              <div class="tabs">
                <div class="tab-list">
                  <button class="tab-btn active" data-tab="tab-rekognition">Rekognition</button>
                  <button class="tab-btn" data-tab="tab-transcribe">Transcribe</button>
                  <button class="tab-btn" data-tab="tab-comprehend">Comprehend</button>
                </div>
              </div>

              <!-- Tab Contents -->
              <div id="tab-rekognition" class="tab-content active">
                <h4 style="margin-bottom:1rem;">Detected Labels</h4>
                <div class="labels-list" id="rekognition-labels">
                  <p style="color:gray;">Loading...</p>
                </div>
              </div>

              <div id="tab-transcribe" class="tab-content">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                  <h4 style="margin:0;">Transcript</h4>
                  <button class="btn btn-secondary btn-sm" onclick="downloadTranscript()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="7 10 12 15 17 10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download
                  </button>
                </div>
                <div class="transcript-box" id="transcript-text">Loading transcript...</div>
              </div>

              <div id="tab-comprehend" class="tab-content">
                <div style="margin-bottom:1.5rem;">
                  <h4 style="margin-bottom:0.5rem;">Sentiment Analysis</h4>
                  <span class="badge badge-secondary" id="sentiment-badge">Loading...</span>
                </div>

                <div>
                  <h4 style="margin-bottom:0.5rem;">Key Phrases</h4>
                  <div class="labels-list" id="comprehend-keywords">
                    <p style="color:gray;">Loading...</p>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Metadata -->
        <div>
          <div class="card">
            <div class="card-header">
              <h3 style="margin:0;">File Information</h3>
            </div>

            <div class="card-body" style="padding:0;">
              <table class="metadata-table" id="metadata-table">
                <tr><th>File Name</th><td>Loading...</td></tr>
                <tr><th>Type</th><td>Loading...</td></tr>
                <tr><th>Size</th><td>Loading...</td></tr>
                <tr><th>Uploaded By</th><td>Loading...</td></tr>
                <tr><th>Upload Time</th><td>Loading...</td></tr>
                <tr><th>Status</th><td>Loading...</td></tr>
                <tr><th>Tags</th><td>Loading...</td></tr>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- Scripts -->
  <script src="{{ url_for('static', filename='js/api.js') }}"></script>
  <script src="{{ url_for('static', filename='js/app.js') }}"></script>

  <!-- ðŸ”¥ Inline Real Detail Script -->
  <script>
    function getTypeGroup(ext) {
      const e = (ext || "").toLowerCase();
      if (["jpg","jpeg","png","gif","webp"].includes(e)) return "image";
      if (["mp4","mov","mkv","webm"].includes(e)) return "video";
      if (["mp3","wav","aac","ogg"].includes(e)) return "audio";
      return "other";
    }

    function initTabs() {
      const tabBtns = document.querySelectorAll(".tab-btn");
      const tabContents = document.querySelectorAll(".tab-content");

      tabBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const tabId = btn.dataset.tab;

          tabBtns.forEach((b) => b.classList.remove("active"));
          tabContents.forEach((c) => c.classList.remove("active"));

          btn.classList.add("active");
          document.getElementById(tabId)?.classList.add("active");
        });
      });
    }

    function renderAnalysisResults(analysis) {
      // Rekognition
      const labelsContainer = document.getElementById("rekognition-labels");
      if (labelsContainer) {
        const labels = analysis?.rekognition?.labels || [];
        if (labels.length === 0) {
          labelsContainer.innerHTML = `<p style="color:gray;">No labels detected</p>`;
        } else {
          labelsContainer.innerHTML = labels.map(l => `
            <div class="label-item">
              <span>${l.Name}</span>
              <span class="label-confidence">${Math.round(l.Confidence)}%</span>
            </div>
          `).join("");
        }
      }

      // Transcript
      const transcriptBox = document.getElementById("transcript-text");
      if (transcriptBox) {
        transcriptBox.textContent = analysis?.transcribe || "No transcript available";
      }

      // Comprehend
      const sentimentBadge = document.getElementById("sentiment-badge");
      if (sentimentBadge) {
        sentimentBadge.textContent = analysis?.comprehend?.sentiment || "N/A";
      }

      const keywordsContainer = document.getElementById("comprehend-keywords");
      if (keywordsContainer) {
        const phrases = analysis?.comprehend?.key_phrases || [];
        if (phrases.length === 0) {
          keywordsContainer.innerHTML = `<p style="color:gray;">No key phrases</p>`;
        } else {
          keywordsContainer.innerHTML = phrases.map(p => `
            <span class="badge badge-primary">${p}</span>
          `).join("");
        }
      }
    }

    function downloadTranscript() {
      const text = document.getElementById("transcript-text")?.textContent || "";
      if (!text || text === "Loading transcript...") {
        window.showToast?.("No transcript available", "error");
        return;
      }

      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "transcript.txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      URL.revokeObjectURL(url);
    }

    async function loadMediaDetail(mediaId) {
      try {
        const res = await fetch(`/api/media/${mediaId}`, {
          method: "GET",
          credentials: "include",
        });

        const data = await res.json();
        console.log("MEDIA DETAIL =>", data);

        if (!data.success) {
          window.showToast?.(data.message || "Media not found", "error");
          return;
        }

        const media = data.media;
        const analysis = data.analysis;

        // Header filename
        const filenameEl = document.getElementById("media-filename");
        if (filenameEl) filenameEl.textContent = media.filename;

        // Preview
        const viewer = document.getElementById("media-viewer");
        const fileUrl = `/static/uploads/${media.stored_name}`;
        const typeGroup = getTypeGroup(media.type);

        if (viewer) {
          if (typeGroup === "image") {
            viewer.innerHTML = `<img src="${fileUrl}" style="width:100%; height:100%; object-fit:contain; border-radius:12px;" />`;
          } else if (typeGroup === "video") {
            viewer.innerHTML = `
              <video controls style="width:100%; border-radius:12px;">
                <source src="${fileUrl}" type="video/mp4">
              </video>
            `;
          } else if (typeGroup === "audio") {
            viewer.innerHTML = `
              <audio controls style="width:100%;">
                <source src="${fileUrl}">
              </audio>
            `;
          } else {
            viewer.innerHTML = `<div style="padding:30px; color:gray;">Preview not supported</div>`;
          }
        }

        // Metadata
        const metadataTable = document.getElementById("metadata-table");
        if (metadataTable) {
          metadataTable.innerHTML = `
            <tr><th>File Name</th><td>${media.filename}</td></tr>
            <tr><th>Type</th><td>${(media.type || "").toUpperCase()}</td></tr>
            <tr><th>Size</th><td>${media.size_kb} KB</td></tr>
            <tr><th>Uploaded By</th><td>${media.email}</td></tr>
            <tr><th>Upload Time</th><td>${media.uploaded_at}</td></tr>
            <tr><th>Status</th><td><span class="badge badge-secondary">${media.status}</span></td></tr>
            <tr><th>Tags</th><td>${(media.tags || []).join(", ") || "â€”"}</td></tr>
          `;
        }

        // Analysis
        renderAnalysisResults(analysis);

        // Download button
        const downloadBtn = document.getElementById("download-btn");
        if (downloadBtn) {
          downloadBtn.onclick = () => {
            window.open(fileUrl, "_blank");
          };
        }

        // Delete button
        const deleteBtn = document.getElementById("delete-btn");
        if (deleteBtn) {
          deleteBtn.onclick = async () => {
            const ok = confirm("Are you sure you want to delete this media?");
            if (!ok) return;

            try {
              const delRes = await fetch(`/api/media/${mediaId}`, {
                method: "DELETE",
                credentials: "include",
              });

              const delData = await delRes.json();
              if (delRes.ok && delData.success) {
                window.showToast?.("Media deleted successfully", "success");
                setTimeout(() => {
                  window.location.href = "/media";
                }, 700);
              } else {
                window.showToast?.(delData.message || "Delete failed", "error");
              }
            } catch (e) {
              window.showToast?.("Server error while deleting", "error");
            }
          };
        }

      } catch (err) {
        console.error(err);
        window.showToast?.("Failed to load media details", "error");
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // protect page
      if (window.requireAuth) {
        const ok = await window.requireAuth();
        if (!ok) return;
      }

      initTabs();

      const params = new URLSearchParams(window.location.search);
      const mediaId = params.get("id");

      if (!mediaId) {
        window.showToast?.("Media ID not found in URL", "error");
        return;
      }

      loadMediaDetail(mediaId);
    });
  </script>
</body>
</html>
